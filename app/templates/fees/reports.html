{# templates/fees/reports.html - replace your current file with this #}
{% extends "base.html" %}
{% block title %}Fees Reports | Tatwadarsha ERP{% endblock %}

{% block content %}
<div class="container-fluid">
  <h4 class="fw-bold mb-3">ðŸ“Š Fees Reports</h4>

  <!-- Filters card (uses same master endpoints as Assign Fees) -->
  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <div class="row g-2 align-items-end">

        <div class="col-md-2">
          <label class="form-label small">Session</label>
          <select id="filterSession" class="form-select"><option value="">All Sessions</option></select>
        </div>

        <div class="col-md-2">
          <label class="form-label small">Course</label>
          <select id="filterCourse" class="form-select"><option value="">All Courses</option></select>
        </div>

        <div class="col-md-2">
          <label class="form-label small">Branch</label>
          <select id="filterBranch" class="form-select"><option value="">All Branches</option></select>
        </div>

        <div class="col-md-2">
          <label class="form-label small">Department</label>
          <select id="filterDepartment" class="form-select"><option value="">All Departments</option></select>
        </div>

        <div class="col-md-2">
          <label class="form-label small">Batch</label>
          <select id="filterBatch" class="form-select"><option value="">All Batches</option></select>
        </div>

        <div class="col-md-2">
          <label class="form-label small">Fee Head</label>
          <select id="filterHead" class="form-select"><option value="">All Fee Heads</option></select>
        </div>

        <div class="col-12 mt-2">
          <label class="form-label small">Student Search</label>
          <div class="position-relative">
            <input id="studentSearch" class="form-control" placeholder="Type student name and select..." autocomplete="off">
            <div id="studentSuggestions" class="list-group position-absolute w-100" style="z-index:2000; display:none; max-height:260px; overflow:auto;"></div>
          </div>
        </div>

        <div class="col-12 d-flex justify-content-end mt-3">
          <button id="applyFilters" class="btn btn-primary me-2">Apply</button>
          <button id="clearFilters" class="btn btn-light">Clear</button>
        </div>

      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="card shadow-sm">
    <div class="card-body">
      <ul class="nav nav-tabs mb-3" id="reportTabs">
        <li class="nav-item"><a class="nav-link active" data-tab="students">Student-wise</a></li>
        <li class="nav-item"><a class="nav-link" data-tab="batches">Batch-wise</a></li>
        <li class="nav-item"><a class="nav-link" data-tab="daily">Daily Collection</a></li>
        <li class="nav-item"><a class="nav-link" data-tab="range">Date Range</a></li>
        <li class="nav-item"><a class="nav-link" data-tab="heads">Head-wise</a></li>
        <li class="nav-item"><a class="nav-link" data-tab="defaulters">Defaulters</a></li>
      </ul>

      <div id="tabContent">
        <!-- Student-wise -->
        <div class="tab-pane" id="pane-students" style="display:block;">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="text-muted small">Student-wise fee snapshot</div>
            <div>
              <button id="exportStudents" class="btn btn-sm btn-outline-secondary">Export CSV</button>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-sm" id="tblStudents">
              <thead><tr>
                <th>Student</th><th>Roll/Enroll</th><th>Assigned</th><th>Paid</th><th>Pending</th><th>Last Payment</th><th></th>
              </tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <!-- Batch-wise -->
        <div class="tab-pane" id="pane-batches" style="display:none;">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="text-muted small">Batch summary</div>
            <div><button id="exportBatches" class="btn btn-sm btn-outline-secondary">Export CSV</button></div>
          </div>
          <div class="table-responsive">
            <table class="table table-sm" id="tblBatches">
              <thead><tr><th>Batch</th><th>Students</th><th>Assigned</th><th>Collected</th><th>Pending</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <!-- Daily -->
        <div class="tab-pane" id="pane-daily" style="display:none;">
          <div class="row mb-2">
            <div class="col-md-3">
              <label class="form-label small">Date</label>
              <input id="dailyDate" type="date" class="form-control form-control-sm">
            </div>
            <div class="col d-flex justify-content-end align-items-end gap-2">
              <button id="exportDaily" class="btn btn-sm btn-outline-secondary">Export CSV</button>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-sm" id="tblDaily">
              <thead><tr><th>Receipt</th><th>Student</th><th>Amount</th><th>Mode</th><th>Time</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <!-- Range -->
        <div class="tab-pane" id="pane-range" style="display:none;">
          <div class="row mb-3">
            <div class="col-md-3"><label class="small">From</label><input id="rangeFrom" type="date" class="form-control form-control-sm"></div>
            <div class="col-md-3"><label class="small">To</label><input id="rangeTo" type="date" class="form-control form-control-sm"></div>
            <div class="col-md-3 d-flex align-items-end"><button id="applyRange" class="btn btn-primary btn-sm">Apply</button></div>
            <div class="col d-flex justify-content-end align-items-end"><button id="exportRange" class="btn btn-sm btn-outline-secondary">Export CSV</button></div>
          </div>
          <div class="table-responsive">
            <table class="table table-sm" id="tblRange">
              <thead><tr><th>Receipt</th><th>Student</th><th>Amount</th><th>Mode</th><th>Date</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="text-muted mt-2" id="rangeTotal">Total: â€”</div>
        </div>

        <!-- Heads -->
        <div class="tab-pane" id="pane-heads" style="display:none;">
          <div class="d-flex justify-content-between mb-2">
            <div class="text-muted small">Head-wise collection</div>
            <div><button id="exportHeads" class="btn btn-sm btn-outline-secondary">Export CSV</button></div>
          </div>
          <div class="table-responsive">
            <table class="table table-sm" id="tblHeads">
              <thead><tr><th>Head</th><th>Assigned</th><th>Collected</th><th>Pending</th><th>% Collected</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <!-- Defaulters -->
        <div class="tab-pane" id="pane-defaulters" style="display:none;">
          <div class="row mb-3">
            <div class="col-md-3"><label class="small">Min Pending (â‚¹)</label><input id="defThreshold" type="number" class="form-control form-control-sm" value="1000"></div>
            <div class="col-md-3 d-flex align-items-end"><button id="findDefaulters" class="btn btn-primary btn-sm">Find</button></div>
            <div class="col d-flex justify-content-end align-items-end"><button id="exportDefaulters" class="btn btn-sm btn-outline-secondary">Export CSV</button></div>
          </div>
          <div class="table-responsive">
            <table class="table table-sm" id="tblDefaulters">
              <thead><tr><th>Student</th><th>Pending</th><th>Last Payment</th><th></th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

      </div>
    </div>
  </div>

</div>

<!-- Drawer -->
<div id="drawer" class="border bg-white p-3"
     style="position:fixed;right:-520px;top:0;width:480px;height:100vh;z-index:2000;transition:0.2s;">
  <div class="d-flex justify-content-between">
    <div>
      <div id="drawerName" class="fw-bold"></div>
      <div id="drawerMeta" class="text-muted small"></div>
    </div>
    <button id="closeDrawer" class="btn btn-sm btn-outline-secondary">Close</button>
  </div>
  <div id="drawerContent" class="mt-3"></div>
</div>

<!-- small client-side CSV exporter -->
<script>
(function(){

  const $ = (s, ctx=document)=>ctx.querySelector(s);
  const $$ = (s, ctx=document)=>Array.from(ctx.querySelectorAll(s));
  const fmt = n => "â‚¹ " + Number(n||0).toLocaleString("en-IN");
  let state = { studentId: null };

  // --- master loader that matches Assign Fees page
  async function loadMasterOptions(name, sel) {
    sel.innerHTML = '<option value="">All</option>';
    try {
      const res = await fetch('/master/' + encodeURIComponent(name) + '/items');
      const j = await res.json();
      if(j && j.items && Array.isArray(j.items)){
        j.items.forEach(it=>{
          const o = document.createElement('option');
          o.value = it.id;
          o.textContent = it.name;
          sel.appendChild(o);
        });
      }
    } catch(e){ console.error('loadMasterOptions', name, e); }
  }

  // load fee heads (same endpoint as Assign Fees)
  async function loadFeeHeads() {
    try {
      const res = await fetch('/fees/api/heads');
      const j = await res.json();
      if(j && j.items){
        const sel = $('#filterHead');
        sel.innerHTML = '<option value="">All Fee Heads</option>';
        j.items.forEach(h=>{
          const o = document.createElement('option'); o.value = h.id; o.textContent = h.name; sel.appendChild(o);
        });
      }
    } catch(e){ console.error('loadFeeHeads', e); }
  }

  // populate masters
  loadMasterOptions('session', $('#filterSession'));
  loadMasterOptions('course', $('#filterCourse'));
  loadMasterOptions('branch', $('#filterBranch'));
  loadMasterOptions('department', $('#filterDepartment'));
  loadMasterOptions('batch', $('#filterBatch'));
  loadFeeHeads();

  // --- live student search using same API used in Assign Fees
  let studentTimer = 0;
  $('#studentSearch').addEventListener('input', e=>{
    const q = e.target.value.trim();
    state.studentId = null;
    clearTimeout(studentTimer);
    if(!q){ hideSuggestions(); return; }
    studentTimer = setTimeout(()=> searchStudents(q), 300);
  });

  function hideSuggestions(){ const box = $('#studentSuggestions'); if(box){ box.style.display='none'; box.innerHTML=''; } }
  async function searchStudents(q) {
    try {
      const res = await fetch('/api/get_students?search=' + encodeURIComponent(q));
      const j = await res.json();
      const rows = j.success ? (j.students || []) : [];
      const box = $('#studentSuggestions');
      box.innerHTML = '';
      if(!rows.length){ hideSuggestions(); return; }
      rows.slice(0,20).forEach(s=>{
        const a = document.createElement('a');
        a.href='#'; a.className='list-group-item list-group-item-action';
        const name = s.personal?.name || s.name || '';
        const reg = s.academic?.register_number || '';
        a.textContent = name + (reg ? ' â€” ' + reg : '');
        a.dataset.id = s.id;
        a.addEventListener('click', ev=>{
          ev.preventDefault();
          $('#studentSearch').value = a.textContent;
          state.studentId = a.dataset.id;
          hideSuggestions();
        });
        box.appendChild(a);
      });
      box.style.display = 'block';
    } catch(e){ hideSuggestions(); console.error('searchStudents', e); }
  }

  // hide suggestions on outside click
  document.addEventListener('click', (ev)=>{
    const box = $('#studentSuggestions');
    if(!box) return;
    if(!box.contains(ev.target) && ev.target !== $('#studentSearch')) box.style.display='none';
  });

  // --- tabs handling
  $$('#reportTabs .nav-link').forEach(a=> a.addEventListener('click', ()=>{
    $$('#reportTabs .nav-link').forEach(x=>x.classList.remove('active'));
    a.classList.add('active');
    const tab = a.dataset.tab;
    $$('.tab-pane').forEach(p=> p.style.display='none');
    const pane = document.getElementById('pane-' + tab);
    if(pane) pane.style.display='block';
    // load data
    if(tab === 'students') loadStudents();
    if(tab === 'batches') loadBatches();
    if(tab === 'daily') loadDaily();
    if(tab === 'heads') loadHeads();
  }));

  // gather filter values
  function getFilters() {
    return {
      session: $('#filterSession') ? $('#filterSession').value : '',
      course: $('#filterCourse') ? $('#filterCourse').value : '',
      branch: $('#filterBranch') ? $('#filterBranch').value : '',
      department: $('#filterDepartment') ? $('#filterDepartment').value : '',
      batch: $('#filterBatch') ? $('#filterBatch').value : '',
      head: $('#filterHead') ? $('#filterHead').value : '',
      student: state.studentId || ''
    };
  }

  // --- API loaders and renderers ---
  async function loadStudents() {
    const q = new URLSearchParams(getFilters()).toString();
    try {
      const res = await fetch('/fees/api/reports/students?' + q);
      const rows = res.ok ? await res.json() : [];
      const tbody = $('#tblStudents tbody'); tbody.innerHTML = '';
      if(!rows.length){ tbody.innerHTML = '<tr><td colspan="7" class="text-muted">No records found</td></tr>'; return; }
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.name || ''}</td>
          <td class="text-muted">${r.roll || r.enrolment || ''}</td>
          <td>${fmt(r.assigned || 0)}</td>
          <td>${fmt(r.paid || 0)}</td>
          <td>${fmt((r.assigned || 0) - (r.paid || 0))}</td>
          <td class="text-muted">${r.last_payment || '-'}</td>
          <td><button class="btn btn-sm btn-outline-secondary view-student" data-id="${r.id}">View</button></td>
        `;
        tbody.appendChild(tr);
      });
    } catch(e){ console.error('loadStudents', e); }
  }

  async function loadBatches() {
    const q = new URLSearchParams(getFilters()).toString();
    try {
      const res = await fetch('/fees/api/reports/batches?' + q);
      const rows = res.ok ? await res.json() : [];
      const tbody = $('#tblBatches tbody'); tbody.innerHTML = '';
      if(!rows.length){ tbody.innerHTML = '<tr><td colspan="5" class="text-muted">No data</td></tr>'; return; }
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.batch_name || r.name}</td><td>${r.students || 0}</td><td>${fmt(r.assigned || 0)}</td><td>${fmt(r.collected || 0)}</td><td>${fmt((r.assigned || 0)-(r.collected || 0))}</td>`;
        tbody.appendChild(tr);
      });
    } catch(e){ console.error('loadBatches', e); }
  }

  async function loadDaily() {
    const filters = getFilters();
    filters.date = $('#dailyDate').value || new Date().toISOString().slice(0,10);
    const q = new URLSearchParams(filters).toString();
    try {
      const res = await fetch('/fees/api/reports/collections?' + q);
      const rows = res.ok ? await res.json() : [];
      const tbody = $('#tblDaily tbody'); tbody.innerHTML = '';
      if(!rows.length){ tbody.innerHTML = '<tr><td colspan="5" class="text-muted">No receipts</td></tr>'; return; }
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.receipt_no || r.no}</td><td>${r.student_name || r.student}</td><td>${fmt(r.amount)}</td><td>${r.mode || ''}</td><td class="text-muted">${r.time || r.date || ''}</td>`;
        tbody.appendChild(tr);
      });
    } catch(e){ console.error('loadDaily', e); }
  }

  async function loadRange(from,to) {
    const filters = getFilters();
    filters.from = from; filters.to = to;
    const q = new URLSearchParams(filters).toString();
    try {
      const res = await fetch('/fees/api/reports/collections?' + q);
      const rows = res.ok ? await res.json() : [];
      const tbody = $('#tblRange tbody'); tbody.innerHTML = '';
      let total = 0;
      if(!rows.length){ tbody.innerHTML = '<tr><td colspan="5" class="text-muted">No receipts</td></tr>'; $('#rangeTotal').textContent = 'Total: â€”'; return; }
      rows.forEach(r=>{
        total += Number(r.amount || 0);
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.receipt_no || r.no}</td><td>${r.student_name || r.student}</td><td>${fmt(r.amount)}</td><td>${r.mode || ''}</td><td class="text-muted">${r.date || ''}</td>`;
        tbody.appendChild(tr);
      });
      $('#rangeTotal').textContent = 'Total: ' + fmt(total);
    } catch(e){ console.error('loadRange', e); }
  }

  async function loadHeads() {
    const q = new URLSearchParams(getFilters()).toString();
    try {
      const res = await fetch('/fees/api/reports/heads?' + q);
      const rows = res.ok ? await res.json() : [];
      const tbody = $('#tblHeads tbody'); tbody.innerHTML = '';
      if(!rows.length){ tbody.innerHTML = '<tr><td colspan="5" class="text-muted">No data</td></tr>'; return; }
      rows.forEach(r=>{
        const pending = (r.assigned || 0) - (r.collected || 0);
        const pct = r.assigned ? Math.round((r.collected / r.assigned) * 100) : 0;
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.name}</td><td>${fmt(r.assigned || 0)}</td><td>${fmt(r.collected || 0)}</td><td>${fmt(pending)}</td><td>${pct}%</td>`;
        tbody.appendChild(tr);
      });
    } catch(e){ console.error('loadHeads', e); }
  }

  async function loadDefaulters(threshold) {
    const filters = getFilters();
    filters.threshold = threshold;
    const q = new URLSearchParams(filters).toString();
    try {
      const res = await fetch('/fees/api/reports/defaulters?' + q);
      const rows = res.ok ? await res.json() : [];
      const tbody = $('#tblDefaulters tbody'); tbody.innerHTML = '';
      if(!rows.length){ tbody.innerHTML = '<tr><td colspan="4" class="text-muted">No defaulters</td></tr>'; return; }
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.name}</td><td>${fmt(r.pending)}</td><td class="text-muted">${r.last_payment || '-'}</td><td><button class="btn btn-sm btn-outline-secondary">Notify</button></td>`;
        tbody.appendChild(tr);
      });
    } catch(e){ console.error('loadDefaulters', e); }
  }

  // --- drawer - student details and receipt
  $('#closeDrawer').addEventListener('click', ()=>{ $('#drawer').style.right = '-520px'; });

  document.body.addEventListener('click', (ev) => {
    const t = ev.target;
    if(t.closest && t.closest('.view-student')){
      const id = t.dataset.id;
      showStudentDetail(id);
    }
  });

  async function showStudentDetail(id){
    try {
      const res = await fetch('/fees/api/students/' + encodeURIComponent(id));
      if(!res.ok) return;
      const d = await res.json();
      $('#drawerName').textContent = d.name || '';
      $('#drawerMeta').textContent = `${d.roll || ''} â€¢ ${d.batch || ''} â€¢ ${d.course || ''}`;
      let html = `<h6>Fee Summary</h6><div>Assigned: ${fmt(d.assigned || 0)}</div><div>Paid: ${fmt(d.paid || 0)}</div><div>Pending: ${fmt((d.assigned||0)-(d.paid||0))}</div><h6 class="mt-3">Payments</h6>`;
      if(Array.isArray(d.payments) && d.payments.length){
        d.payments.forEach(p => html += `<div>${p.payment_date} â€” ${fmt(p.amount)} â€” ${p.mode || ''}</div>`);
      } else {
        html += `<div class="text-muted">No payments</div>`;
      }
      $('#drawerContent').innerHTML = html;
      $('#drawer').style.right = '0';
    } catch(e){ console.error('showStudentDetail', e); }
  }

  // --- events
  $('#applyFilters').addEventListener('click', ()=>{
    const active = $('#reportTabs .nav-link.active').dataset.tab;
    if(active === 'students') loadStudents();
    if(active === 'batches') loadBatches();
    if(active === 'daily') loadDaily();
    if(active === 'heads') loadHeads();
    if(active === 'defaulters') loadDefaulters($('#defThreshold').value || 0);
  });

  $('#clearFilters').addEventListener('click', ()=>{
    ['#filterSession','#filterCourse','#filterBranch','#filterDepartment','#filterBatch','#filterHead'].forEach(sel=>{
      if($(sel)) $(sel).value = '';
    });
    $('#studentSearch').value = '';
    state.studentId = null;
  });

  $('#applyRange').addEventListener('click', ()=>{
    const f = $('#rangeFrom').value, t = $('#rangeTo').value;
    if(!f || !t){ alert('Select From and To dates'); return; }
    loadRange(f,t);
  });

  $('#findDefaulters').addEventListener('click', ()=> loadDefaulters($('#defThreshold').value || 0));

  // --- export helpers (client-side CSV)
  function tableToCSV(tableSelector){
    const rows = [];
    const table = document.querySelector(tableSelector);
    if(!table) return '';
    const headers = Array.from(table.querySelectorAll('thead th')).map(th=>th.innerText.trim());
    rows.push(headers.join(','));
    table.querySelectorAll('tbody tr').forEach(tr=>{
      const cols = Array.from(tr.querySelectorAll('td')).map(td=>{
        // sanitize
        return '"' + (td.innerText.replace(/"/g,'""').trim()) + '"';
      });
      rows.push(cols.join(','));
    });
    return rows.join('\n');
  }

  function downloadCSV(content, filename){
    const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }

  // attach export buttons
  $('#exportStudents').addEventListener('click', ()=> {
    const csv = tableToCSV('#tblStudents');
    if(!csv) return alert('No data to export');
    downloadCSV(csv, 'students_report.csv');
  });
  $('#exportBatches').addEventListener('click', ()=> {
    const csv = tableToCSV('#tblBatches'); if(!csv) return alert('No data'); downloadCSV(csv,'batches_report.csv');
  });
  $('#exportDaily').addEventListener('click', ()=> {
    const csv = tableToCSV('#tblDaily'); if(!csv) return alert('No data'); downloadCSV(csv,'daily_collection.csv');
  });
  $('#exportRange').addEventListener('click', ()=> {
    const csv = tableToCSV('#tblRange'); if(!csv) return alert('No data'); downloadCSV(csv,'range_collection.csv');
  });
  $('#exportHeads').addEventListener('click', ()=> {
    const csv = tableToCSV('#tblHeads'); if(!csv) return alert('No data'); downloadCSV(csv,'headwise_report.csv');
  });
  $('#exportDefaulters').addEventListener('click', ()=> {
    const csv = tableToCSV('#tblDefaulters'); if(!csv) return alert('No data'); downloadCSV(csv,'defaulters.csv');
  });

  // --- initial load
  (function init(){
    // set default daily date
    $('#dailyDate').value = new Date().toISOString().slice(0,10);
    // load initial visible tab
    loadStudents();
  })();

})();
</script>

{% endblock %}
