{% extends "base.html" %}
{% block content %}

<div class="container-fluid py-3">
  <h4 class="fw-bold mb-3">ðŸ’° Collect Fees</h4>

  <!-- Top controls: Payment Mode + Student Search -->
  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <div class="d-flex gap-2 align-items-center">
        <button id="btnNewPaymentMode" class="btn btn-sm btn-outline-primary">+ Payment Mode</button>
        <div class="flex-fill">
          <label class="form-label small mb-1">Student Search</label>
          <input id="studentSearch" class="form-control" placeholder="Type student name and select..." autocomplete="off">
          <div id="studentSuggestions" class="list-group position-absolute w-100" style="z-index:1050; display:none; max-height:260px; overflow:auto;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main content: ledger left + department fee table right -->
  <div class="row">
    <div class="col-lg-4">
      <div class="card shadow-sm mb-3">
        <div class="card-body">
          <h6 class="mb-2">Student Ledger</h6>
          <div id="ledgerArea" class="small text-muted">Select student to load ledger</div>
        </div>
      </div>
    </div>

    <div class="col-lg-8">
      <div id="feesArea">
        <!-- Department groups will be injected here -->
      </div>
    </div>
  </div>

</div>

<!-- Payment Modal (Collect) -->
<div class="modal fade" id="paymentModal" tabindex="-1">
  <div class="modal-dialog modal-md">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Collect Fee</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="paymentForm">
          <input type="hidden" id="pm_student_id">
          <input type="hidden" id="pm_assigned_id">
          <input type="hidden" id="pm_head_id">

          <div class="mb-2"><label class="form-label small">Fee Head</label><div id="pm_head_name" class="fw-bold"></div></div>
          <div class="row g-2">
            <div class="col-6">
              <label class="form-label small">Total Assigned</label>
              <input id="pm_total" class="form-control form-control-sm" readonly>
            </div>
            <div class="col-6">
              <label class="form-label small">Already Paid</label>
              <input id="pm_paid" class="form-control form-control-sm" readonly>
            </div>
            <div class="col-6">
              <label class="form-label small">Balance</label>
              <input id="pm_balance" class="form-control form-control-sm" readonly>
            </div>
            <div class="col-6">
              <label class="form-label small">Now Paying</label>
              <input id="pm_amount" name="amount" type="number" step="0.01" class="form-control form-control-sm" required>
            </div>
            <div class="col-6">
              <label class="form-label small">Payment Date</label>
              <input id="pm_date" name="payment_date" type="date" class="form-control form-control-sm" required>
            </div>
            <div class="col-6">
              <label class="form-label small">Receipt No</label>
              <input id="pm_receipt" name="receipt_no" class="form-control form-control-sm" readonly>
            </div>
            <div class="col-12">
              <label class="form-label small">Payment Mode</label>
              <select id="pm_mode" name="mode" class="form-select form-select-sm"></select>
            </div>

            <!-- dynamic area for mode-specific fields -->
            <div class="col-12 mt-2" id="pm_mode_fields"></div>

            <div class="col-12">
              <label class="form-label small">Remark</label>
              <textarea id="pm_remark" name="remark" class="form-control form-control-sm" rows="2"></textarea>
            </div>
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button id="pm_save" class="btn btn-primary">Collect & Print</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- Payment Mode Master Modal (Add/Edit) -->
<div class="modal fade" id="pmMasterModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Payment Modes</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <!-- New / Edit form -->
        <form id="pmMasterForm" class="mb-3">
          <input type="hidden" id="pm_edit_id" value="">
          <div class="row g-2">
            <div class="col-md-6">
              <label class="form-label small">Mode Name</label>
              <input id="pm_mode_name" class="form-control form-control-sm" required>
            </div>
            <div class="col-md-6">
              <label class="form-label small">Attach file (optional)</label>
              <input id="pm_file" type="file" class="form-control form-control-sm" accept=".jpg,.jpeg,.png,.pdf,.doc,.docx,.xlsx,.xls">
            </div>

            <div class="col-12">
              <label class="form-label small">Fields (tick to add)</label>
              <div class="d-flex flex-wrap gap-2">
                <div class="form-check"><input id="fld_remark" class="form-check-input" type="checkbox"><label class="form-check-label ms-1">Remark</label></div>
                <div class="form-check"><input id="fld_utr" class="form-check-input" type="checkbox"><label class="form-check-label ms-1">UTR / Transaction ID</label></div>
                <div class="form-check"><input id="fld_payee" class="form-check-input" type="checkbox"><label class="form-check-label ms-1">Payee Name</label></div>
                <div class="form-check"><input id="fld_bank" class="form-check-input" type="checkbox"><label class="form-check-label ms-1">Bank Name</label></div>
                <div class="form-check"><input id="fld_cheque_no" class="form-check-input" type="checkbox"><label class="form-check-label ms-1">Cheque No</label></div>
                <div class="form-check"><input id="fld_cheque_date" class="form-check-input" type="checkbox"><label class="form-check-label ms-1">Cheque Date</label></div>
                <div class="form-check"><input id="fld_deposit_bank" class="form-check-input" type="checkbox"><label class="form-check-label ms-1">Deposit Bank</label></div>
                <div class="form-check"><input id="fld_deposit_date" class="form-check-input" type="checkbox"><label class="form-check-label ms-1">Deposit Date</label></div>
                <div class="form-check"><input id="fld_refno" class="form-check-input" type="checkbox"><label class="form-check-label ms-1">Reference No</label></div>
              </div>
            </div>

            <div class="col-12">
              <button id="pmMasterSave" class="btn btn-primary btn-sm mt-2">Save Mode</button>
              <button id="pmMasterClear" type="button" class="btn btn-secondary btn-sm mt-2 ms-2">Clear</button>
            </div>
          </div>
        </form>

        <hr>

        <!-- Existing modes list -->
        <div id="pmList" class="list-group"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}

<script>
(function(){
  const $ = (s, ctx=document) => ctx.querySelector(s);
  const $$ = (s, ctx=document) => Array.from((ctx||document).querySelectorAll(s));
  const fmt = n => "â‚¹ " + Number(n||0).toLocaleString("en-IN");

  let state = { student: null, assignedGroups: [], studentName: null };
  let paymentModes = [];

  // Student search autosuggest
  let stTimer = 0;
  $('#studentSearch').addEventListener('input', (e)=>{
    const q = e.target.value.trim();
    clearTimeout(stTimer);
    if(!q){ $('#studentSuggestions').style.display='none'; return; }
    stTimer = setTimeout(()=> searchStudents(q), 250);
  });

  async function searchStudents(q){
    try {
      const res = await fetch('/api/get_students?search=' + encodeURIComponent(q));
      const j = await res.json();
      const list = j.students || [];
      const box = $('#studentSuggestions'); box.innerHTML = '';
      if(!list.length){ box.style.display = 'none'; return; }
      list.slice(0,12).forEach(s => {
        const a = document.createElement('a'); a.href='#';
        const name = s.personal?.name || s.name || '';
        a.className = 'list-group-item list-group-item-action';
        a.textContent = name + (s.academic?.register_number ? ' â€” ' + s.academic.register_number : '');
        a.dataset.id = s.id;
        a.addEventListener('click', ev => {
          ev.preventDefault();
          $('#studentSearch').value = a.textContent;
          $('#studentSuggestions').style.display='none';
          state.studentName = name;
          loadStudentAssigned(a.dataset.id);
        });
        box.appendChild(a);
      });
      box.style.display = 'block';
    } catch(e){ console.error(e); }
  }

  // load assigned fees grouped by department
  async function loadStudentAssigned(student_id){
    try {
      const res = await fetch('/fees/api/assigned?student_id=' + encodeURIComponent(student_id));
      const j = await res.json();
      if(!j.success){ alert('Failed to load assigned fees'); return; }
      state.student = j.student || null;
      state.assignedGroups = j.groups || [];
      renderLedgerAndFees(j.groups || []);
    } catch(e){ console.error(e); }
  }

  function renderLedgerAndFees(groups){
    const ledger = $('#ledgerArea');
    let totalAssigned = 0, totalPaid = 0, totalBalance = 0;
    (groups||[]).forEach(g => (g.items||[]).forEach(it => { totalAssigned += Number(it.assigned_amount||0); totalPaid += Number(it.paid_amount||0); totalBalance += Number(it.balance||0); }));

    let ledgerHtml = '';
    if(!groups || groups.length===0){
      ledgerHtml = '<div class="text-muted">No assigned fees</div>';
    } else {
      const sample = groups[0].items[0] || {};
      const displayName = state.studentName || sample.student_name || sample.student_id || state.student || '';
      ledgerHtml += `<div><strong>${displayName}</strong></div>`;
      ledgerHtml += `<div class="mt-2">Assigned: ${fmt(totalAssigned)}</div>`;
      ledgerHtml += `<div>Paid: ${fmt(totalPaid)}</div>`;
      ledgerHtml += `<div>Balance: ${fmt(totalBalance)}</div>`;
    }
    ledger.innerHTML = ledgerHtml;

    const feesArea = $('#feesArea'); feesArea.innerHTML = '';
    (groups||[]).forEach(g => {
      const card = document.createElement('div'); card.className = 'card mb-3';
      card.innerHTML = `
        <div class="card-body">
          <div class="fw-bold mb-2" style="background:#eafaf7;padding:8px;border-radius:4px;">Department: ${g.department}</div>
          <div class="table-responsive">
            <table class="table table-sm">
              <thead class="table-light"><tr><th style="width:40px"></th><th>Particular</th><th>Amount</th><th>Paid Amt</th><th>Bal Amt</th><th>Now Paid</th><th>Status</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      `;
      const tbody = card.querySelector('tbody');
      (g.items||[]).forEach(it => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input class="form-check-input asg-chk" type="checkbox" data-assigned='${it.assigned_id}'></td>
          <td><a href="#" class="collect-link" data-assigned='${it.assigned_id}' data-head='${it.head_id}'>${it.head_name || 'Fee'}</a></td>
          <td>${fmt(it.assigned_amount)}</td>
          <td>${fmt(it.paid_amount)}</td>
          <td>${fmt(it.balance)}</td>
          <td><input type="number" step="0.01" class="form-control form-control-sm now-pay" data-assigned='${it.assigned_id}' style="width:110px"></td>
          <td><span class="badge bg-${(it.assigned_status === 'Paid') ? 'success' : (it.paid_amount>0 ? 'warning' : 'secondary')}">${it.assigned_status || (it.paid_amount>0 ? 'Partial' : 'Not Paid')}</span></td>
        `;
        tbody.appendChild(tr);
      });
      feesArea.appendChild(card);
    });

    $$('.collect-link').forEach(a=>{
      a.addEventListener('click', (ev)=>{
        ev.preventDefault();
        const assigned_id = a.dataset.assigned;
        openPaymentModal(assigned_id);
      });
    });
  }

  // load payment modes into select and state
  async function loadPaymentModes(){
    try {
      const res = await fetch('/fees/api/payment_modes');
      const j = await res.json();
      if(j.success){
        paymentModes = j.items || [];
        const sel = $('#pm_mode');
        sel.innerHTML = '';
        const blank = document.createElement('option'); blank.value = ''; blank.textContent = 'Select mode'; sel.appendChild(blank);
        paymentModes.forEach(m => {
          const o = document.createElement('option'); o.value = m.id; o.textContent = m.name; sel.appendChild(o);
        });
      }
      // also update the modal list if open
      renderPaymentModeList();
    } catch(e){ console.error(e); }
  }

  // open collect modal
  async function openPaymentModal(assigned_id){
    // find assigned item
    let found = null;
    (state.assignedGroups || []).forEach(g => (g.items||[]).forEach(it => { if(it.assigned_id === assigned_id) found = it; }));
    if(!found){ alert('Assigned fee not found'); return; }
    $('#pm_student_id').value = found.student_id;
    $('#pm_assigned_id').value = found.assigned_id;
    $('#pm_head_id').value = found.head_id;
    $('#pm_head_name').textContent = found.head_name || '';
    $('#pm_total').value = found.assigned_amount || 0;
    $('#pm_paid').value = found.paid_amount || 0;
    $('#pm_balance').value = found.balance || 0;
    $('#pm_amount').value = Math.min(found.balance || 0, found.assigned_amount || 0);
    $('#pm_date').value = new Date().toISOString().slice(0,10);
    $('#pm_receipt').value = '';
    $('#pm_mode_fields').innerHTML = '';
    $('#pm_remark').value = '';
    new bootstrap.Modal(document.getElementById('paymentModal')).show();
  }

  // build dynamic fields when pm_mode changes
  $('#pm_mode').addEventListener('change', (e)=>{
    const selectedId = e.target.value;
    const def = paymentModes.find(m => m.id === selectedId);
    const container = $('#pm_mode_fields');
    container.innerHTML = '';
    function addInput(name, label, type='text'){ container.insertAdjacentHTML('beforeend', `<div class="mb-2"><label class="form-label small">${label}</label><input id="pm_field_${name}" name="${name}" class="form-control form-control-sm" ${type==='date' ? 'type="date"' : ''}></div>`); }
    if(!def){
      addInput('remark_extra','Remark');
    } else {
      let flds = [];
      try{ flds = typeof def.fields === 'string' ? JSON.parse(def.fields || '[]') : (def.fields || []); } catch(e){ flds = []; }
      if(!flds.length) addInput('remark_extra','Remark'); else flds.forEach(fn => addInput(fn, fn.replace(/_/g,' ').toUpperCase(), fn.includes('date') ? 'date' : 'text'));
    }
  });

  // Save payment (Collect & Print) â€” to /fees/collect/pay
  $('#pm_save').addEventListener('click', async (ev)=>{
    ev.preventDefault();
    const student_id = $('#pm_student_id').value;
    const assigned_id = $('#pm_assigned_id').value;
    const amount = Number($('#pm_amount').value || 0);
    const mode_id = $('#pm_mode').value;
    const date = $('#pm_date').value;
    const remark = $('#pm_remark').value;

    if(!amount || amount <= 0){ alert('Enter amount'); return; }
    if(!mode_id){ alert('Select payment mode'); return; }

    // gather mode meta fields
    const meta = {};
    $$('#pm_mode_fields input, #pm_mode_fields textarea').forEach(inp => { const name = inp.name || inp.id.replace('pm_field_',''); meta[name] = inp.value; });

    const payload = {
      assigned_fee_id: assigned_id,
      student_id: student_id,
      amount: amount,
      payment_mode_id: mode_id,
      reference_no: meta.reference_no || meta.utr || '',
      paid_on: date
    };

    try {
      const res = await fetch('/fees/collect/pay', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });
      const j = await res.json();
      if(!j.success){ alert('Save failed: ' + (j.message||'error')); return; }

      const modalEl = document.getElementById('paymentModal');
      const modalInst = bootstrap.Modal.getInstance(modalEl);
      if(modalInst) modalInst.hide();

      loadStudentAssigned(student_id);
      showToast('Payment Collected Successfully', 'success');

      if(j.receipt_id){
        const w = window.open('/receipt/view/' + encodeURIComponent(j.receipt_id), '_blank');
        if(w) w.focus();
      }
    } catch(e){
      console.error(e); alert('Save error');
    }
  });

  // toast helper
  function showToast(msg, type='success'){
    const id = 't' + Date.now();
    const cont = document.createElement('div');
    cont.innerHTML = `<div id="${id}" class="toast align-items-center text-bg-${type} border-0 show" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="3000"><div class="d-flex"><div class="toast-body">${msg}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div></div>`;
    document.body.appendChild(cont);
    setTimeout(()=> cont.remove(), 3200);
  }

  // Payment Mode modal open â€” load list
  $('#btnNewPaymentMode').addEventListener('click', async ()=> {
    $('#pm_edit_id').value = '';
    $('#pm_mode_name').value = '';
    $('#pm_file').value = '';
    ['fld_remark','fld_utr','fld_payee','fld_bank','fld_cheque_no','fld_cheque_date','fld_deposit_bank','fld_deposit_date','fld_refno'].forEach(id => { if($( '#' + id)) $('#' + id).checked = false; });
    await loadPaymentModes();
    const modal = new bootstrap.Modal(document.getElementById('pmMasterModal'));
    modal.show();
  });

  // render payment mode list inside modal with edit/delete
  function renderPaymentModeList(){
    const container = $('#pmList');
    if(!container) return;
    container.innerHTML = '';
    if(!paymentModes || !paymentModes.length){
      container.innerHTML = '<div class="text-muted small">No payment modes found.</div>';
      return;
    }
    paymentModes.forEach(m => {
      const item = document.createElement('div');
      item.className = 'list-group-item d-flex justify-content-between align-items-start';
      const left = document.createElement('div');
      left.innerHTML = `<div class="fw-semibold">${m.name}</div><div class="small text-muted">${(m.fields ? (typeof m.fields === 'string' ? m.fields : JSON.stringify(m.fields)) : '')}</div>${m.file_path ? `<div class="small"><a href="${m.file_path}" target="_blank">Attachment</a></div>` : ''}`;
      const right = document.createElement('div');
      right.innerHTML = `<button class="btn btn-sm btn-outline-secondary me-2 pm-edit" data-id="${m.id}">Edit</button><button class="btn btn-sm btn-outline-danger pm-del" data-id="${m.id}">Delete</button>`;
      item.appendChild(left); item.appendChild(right);
      container.appendChild(item);
    });

    // attach events
    $$('.pm-edit').forEach(b => b.addEventListener('click', ev => {
      const id = b.dataset.id;
      const mode = paymentModes.find(x => x.id === id);
      if(!mode) return;
      $('#pm_edit_id').value = mode.id;
      $('#pm_mode_name').value = mode.name || '';
      // set checkboxes from fields
      let flds = [];
      try{ flds = typeof mode.fields === 'string' ? JSON.parse(mode.fields || '[]') : (mode.fields||[]); } catch(e){ flds = []; }
      ['remark','utr','payee','bank','cheque_no','cheque_date','deposit_bank','deposit_date','reference_no'].forEach(fn => {
        const idchk = 'fld_' + (fn==='reference_no' ? 'refno' : fn);
        const el = $('#' + idchk);
        if(el) el.checked = flds.includes(fn);
      });
      // Note: file input cannot be populated for security â€” leave file blank (user can reupload to change)
    }));

    $$('.pm-del').forEach(b => b.addEventListener('click', async ev => {
      const id = b.dataset.id;
      if(!confirm('Delete this payment mode?')) return;
      try {
        const res = await fetch('/fees/api/payment_modes/' + encodeURIComponent(id), { method: 'DELETE' });
        const j = await res.json();
        if(!j.success){ alert('Delete failed'); return; }
        showToast('Deleted', 'success'); await loadPaymentModes();
      } catch(e){ console.error(e); alert('Delete error'); }
    }));
  }

  // Save Payment Mode (with file upload) - POST or PUT
  $('#pmMasterSave').addEventListener('click', async (ev)=>{
    ev.preventDefault();
    const editId = $('#pm_edit_id').value || '';
    const name = $('#pm_mode_name').value.trim();
    if(!name){ alert('Enter name'); return; }

    const fields = [];
    if($('#fld_remark').checked) fields.push('remark');
    if($('#fld_utr').checked) fields.push('utr');
    if($('#fld_payee').checked) fields.push('payee');
    if($('#fld_bank').checked) fields.push('bank');
    if($('#fld_cheque_no').checked) fields.push('cheque_no');
    if($('#fld_cheque_date').checked) fields.push('cheque_date');
    if($('#fld_deposit_bank').checked) fields.push('deposit_bank');
    if($('#fld_deposit_date').checked) fields.push('deposit_date');
    if($('#fld_refno').checked) fields.push('reference_no');

    const fileInput = $('#pm_file');
    const fd = new FormData();
    fd.append('name', name);
    fd.append('fields', JSON.stringify(fields));
    if(fileInput && fileInput.files && fileInput.files[0]) fd.append('file', fileInput.files[0]);

    try {
      const url = editId ? ('/fees/api/payment_modes/' + encodeURIComponent(editId)) : '/fees/api/payment_modes';
      const method = editId ? 'PUT' : 'POST';
      const res = await fetch(url, { method, body: fd });
      const j = await res.json();
      if(!j.success){ alert('Save failed: ' + (j.message || 'error')); return; }
      // hide modal instance
      const mm = document.getElementById('pmMasterModal');
      const inst = bootstrap.Modal.getInstance(mm);
      if(inst) inst.hide();
      await loadPaymentModes();
      showToast('Payment mode saved', 'success');
    } catch(e){ console.error(e); alert('Save error'); }
  });

  // clear pm master form
  $('#pmMasterClear').addEventListener('click', (ev)=>{
    ev.preventDefault();
    $('#pm_edit_id').value = '';
    $('#pm_mode_name').value = '';
    $('#pm_file').value = '';
    ['fld_remark','fld_utr','fld_payee','fld_bank','fld_cheque_no','fld_cheque_date','fld_deposit_bank','fld_deposit_date','fld_refno'].forEach(id => { const el = $('#' + id); if(el) el.checked = false; });
  });

  // hide suggestions when clicking outside
  document.addEventListener('click', (ev) => {
    const box = $('#studentSuggestions');
    if(box && !box.contains(ev.target) && ev.target !== $('#studentSearch')) box.style.display = 'none';
  });

  // initial load
  loadPaymentModes();

})();
</script>

{% endblock %}
