{% extends "base.html" %}
{% block title %}Finance Chatroom{% endblock %}

{% block content %}
<div class="container-fluid mt-3">

  <div class="d-flex justify-content-between align-items-center mb-2">
    <h4 class="fw-bold text-success mb-0">ðŸ’¬ Finance Request Chatroom</h4>
    <div>
      <span class="me-2 small text-muted">
        Logged in as: {{ session['chat_full_name'] }} ({{ role }})
      </span>
      <a href="{{ url_for('chat.chat_logout') }}" class="btn btn-outline-secondary btn-sm">
        Logout
      </a>
    </div>
  </div>

  <div class="row">
    <!-- LEFT: Requests List -->
    <div class="col-md-4 mb-3">
      {% if role == 'accountant' %}
      <div class="card mb-3 shadow-sm border-0">
        <div class="card-body">
          <h6 class="fw-bold text-success mb-2">New Request</h6>
          <form method="POST" action="{{ url_for('chat.create_request') }}" enctype="multipart/form-data">
            <div class="mb-2">
              <label class="form-label small">Amount (â‚¹)</label>
              <input type="number" step="0.01" name="amount" class="form-control form-control-sm" required>
            </div>
            <div class="mb-2">
              <label class="form-label small">Purpose</label>
              <textarea name="purpose" class="form-control form-control-sm" rows="2" required></textarea>
            </div>
            <div class="mb-2">
              <label class="form-label small">Attachment (optional)</label>
              <input type="file" name="attachment" class="form-control form-control-sm">
            </div>
            <button class="btn btn-success btn-sm w-100">Submit Request</button>
          </form>
        </div>
      </div>
      {% endif %}

      <div class="card shadow-sm border-0">
        <div class="card-body p-2">
          <h6 class="fw-bold text-secondary mb-2">Requests</h6>

          <div class="list-group small" style="max-height: 420px; overflow-y: auto;">
            {% for r in requests_list %}
            <a href="{{ url_for('chat.chat_room', request_id=r.id) }}"
               class="list-group-item list-group-item-action d-flex justify-content-between align-items-start
               {% if selected_request and selected_request.id == r.id %} active {% endif %}">
              <div class="me-auto">
                <div class="fw-bold">
                  â‚¹{{ '%.2f'|format(r.amount) }} - {{ r.purpose[:28] }}{% if r.purpose|length > 28 %}...{% endif %}
                </div>
                <div class="small">
                  By: {{ r.requester_name }}<br>
                  {{ r.created_at }}
                </div>
              </div>
              <span class="badge 
                  {% if r.status == 'approved' %} bg-success
                  {% elif r.status == 'rejected' %} bg-danger
                  {% else %} bg-warning text-dark {% endif %}">
                {{ r.status|upper }}
              </span>
            </a>
            {% else %}
            <div class="text-muted small px-2">No requests yet.</div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT: Selected Request + Chat -->
    <div class="col-md-8 mb-3">
      {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, msg in messages %}
        <div class="alert alert-{{ category }} py-2">{{ msg }}</div>
        {% endfor %}
      {% endif %}
      {% endwith %}

      {% if not selected_request %}
      <div class="alert alert-info">
        Select a request on the left to view details and chat.
      </div>
      {% else %}
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <h5 class="mb-1">â‚¹{{ '%.2f'|format(selected_request.amount) }}</h5>
              <p class="mb-1 fw-semibold">{{ selected_request.purpose }}</p>
              <p class="mb-1 small text-muted">
                Requested by: {{ selected_request.requester_name }}<br>
                On: {{ selected_request.created_at }}
              </p>
              {% if selected_request.attachment %}
              <p class="mb-1 small">
                Attachment: <a href="{{ selected_request.attachment }}" target="_blank">View file</a>
              </p>
              {% endif %}
            </div>
            <div class="text-end">
              <span class="badge 
                  {% if selected_request.status == 'approved' %} bg-success
                  {% elif selected_request.status == 'rejected' %} bg-danger
                  {% else %} bg-warning text-dark {% endif %}">
                {{ selected_request.status|upper }}
              </span>
              {% if selected_request.remarks %}
              <div class="small mt-2">
                <strong>Remarks:</strong><br>
                {{ selected_request.remarks }}
              </div>
              {% endif %}
            </div>
          </div>

          <hr class="my-2">

          <!-- Chat messages -->
          <div id="chatBox" class="p-2 border rounded"
               style="height:300px; overflow-y:auto; background:#f7f9f8;">
            {% for m in chat_messages %}
            <div class="mb-2">
              <div class="small fw-bold">
                {{ m.sender_name }}
                <span class="text-muted">({{ m.created_at }})</span>
              </div>
              {% if m.message %}
              <div class="small">{{ m.message }}</div>
              {% endif %}
              {% if m.file_url %}
              <div class="small">
                ðŸ“Ž <a href="{{ m.file_url }}" target="_blank">View attachment</a>
              </div>
              {% endif %}
            </div>
            <hr class="my-1">
            {% else %}
            <div class="small text-muted">No messages yet. Start the discussion below.</div>
            {% endfor %}
          </div>

          <!-- Admin Approve / Reject -->
          {% if role == 'admin' %}
          <form method="POST" action="{{ url_for('chat.approve_request', req_id=selected_request.id) }}" class="mt-3">
            <label class="form-label small">Remarks (for approval / rejection)</label>
            <textarea name="remarks" class="form-control form-control-sm" rows="2">{{ selected_request.remarks or '' }}</textarea>
            <div class="mt-2 text-end">
              <button formaction="{{ url_for('chat.reject_request', req_id=selected_request.id) }}"
                      class="btn btn-sm btn-danger">Reject</button>
              <button class="btn btn-sm btn-success">Approve</button>
            </div>
          </form>
          {% endif %}
        </div>

        <!-- Send message -->
        <div class="card-footer">
          <form method="POST" action="{{ url_for('chat.chat_send') }}" enctype="multipart/form-data" class="row g-2 align-items-center">
            <input type="hidden" name="request_id" value="{{ selected_request.id }}">
            <div class="col-md-6 col-12">
              <input type="text" name="message" class="form-control form-control-sm" placeholder="Type a message...">
            </div>
            <div class="col-md-4 col-12">
              <input type="file" name="file" class="form-control form-control-sm">
            </div>
            <div class="col-md-2 col-12 text-end">
              <button class="btn btn-success btn-sm w-100">Send</button>
            </div>
          </form>
        </div>

      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
