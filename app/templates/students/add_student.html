{% extends "base.html" %}
{% block title %}{{ 'Edit Student' if mode == 'edit' else 'Add Student' }} | Tatwadarsha ERP{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <h4 class="fw-bold mb-4 text-dark">
    {{ 'üìù Edit Student Details' if mode == 'edit' else 'üéì Add New Student' }}
  </h4>

  <form id="studentForm"
        action="{{ url_for('students.update_student', student_id=student_id) if mode == 'edit' else url_for('students.add_student') }}"
        method="POST"
        class="glassy-form card p-4 shadow-sm border-0">

    <!-- Nav Tabs -->
    <ul class="nav nav-tabs mb-4" id="studentTabs" role="tablist">
      <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#personal">Personal</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#academic">Academic</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#family">Family</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#bank">Bank</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#docs">Documents</button></li>
    </ul>

    <div class="tab-content">

      <!-- PERSONAL TAB -->
      <div class="tab-pane fade show active" id="personal">
        <div class="row g-3">

          <div class="col-md-4"><label class="form-label">Full Name</label>
            <input name="name" class="form-control" required value="{{ student.name or '' }}">
          </div>

          <div class="col-md-4"><label class="form-label">Date of Birth</label>
            <input type="date" name="dob" class="form-control" value="{{ student.dob or '' }}">
          </div>

          <div class="col-md-4">
            <label class="form-label">Gender</label>
            <select name="gender" class="form-select">
              <option value="">-- Select --</option>
              <option value="Male" {% if student.gender=='Male' %}selected{% endif %}>Male</option>
              <option value="Female" {% if student.gender=='Female' %}selected{% endif %}>Female</option>
              <option value="Other" {% if student.gender=='Other' %}selected{% endif %}>Other</option>
            </select>
          </div>

          <div class="col-md-4"><label class="form-label">Religion</label>
            <select name="religion" class="form-select" data-value="{{ student.religion or '' }}"></select>
          </div>

          <div class="col-md-4"><label class="form-label">Caste</label>
            <select name="caste" class="form-select" data-value="{{ student.caste or '' }}"></select>
          </div>

          <div class="col-md-4"><label class="form-label">Category</label>
            <select name="category" class="form-select" data-value="{{ student.category or '' }}"></select>
          </div>

          <div class="col-md-4"><label class="form-label">Aadhaar No</label>
            <input name="aadhaar" class="form-control" value="{{ student.aadhaar or '' }}">
          </div>

          <div class="col-md-4"><label class="form-label">Blood Group</label>
            <input name="blood_group" class="form-control" value="{{ student.blood_group or '' }}">
          </div>

          <div class="col-md-4"><label class="form-label">Email</label>
            <input type="email" name="email" class="form-control" value="{{ student.email or '' }}">
          </div>

          <div class="col-md-4"><label class="form-label">Phone</label>
            <input name="phone" class="form-control" maxlength="10" value="{{ student.phone or '' }}">
          </div>

          <div class="col-md-8"><label class="form-label">Address</label>
            <input name="address" class="form-control" value="{{ student.address or '' }}">
          </div>

        </div>
      </div>

      <!-- ACADEMIC TAB -->
      <div class="tab-pane fade" id="academic">
        <div class="row g-3">

          <div class="col-md-4"><label class="form-label">Session</label>
            <select name="session" class="form-select" data-value="{{ student.session or '' }}"></select>
          </div>

          <div class="col-md-4"><label class="form-label">Course</label>
            <select name="course" class="form-select" data-value="{{ student.course or '' }}"></select>
          </div>

          <div class="col-md-4"><label class="form-label">Branch</label>
            <select name="branch" class="form-select" data-value="{{ student.branch or '' }}"></select>
          </div>

          <div class="col-md-4"><label class="form-label">Department</label>
            <select name="department" class="form-select" data-value="{{ student.department or '' }}"></select>
          </div>

          <div class="col-md-4"><label class="form-label">Batch</label>
            <select name="batch" class="form-select" data-value="{{ student.batch or '' }}"></select>
          </div>

          <div class="col-md-4"><label class="form-label">Registration Number</label>
            <input type="text" name="register_number" class="form-control" value="{{ student.register_number or '' }}">
          </div>

          <div class="col-md-4"><label class="form-label">Admission Date</label>
            <input type="date" name="admission_date" class="form-control" value="{{ student.admission_date or '' }}">
          </div>

          <div class="col-md-6"><label class="form-label">Previous School</label>
            <input name="previous_school" class="form-control" value="{{ student.previous_school or '' }}">
          </div>

          <div class="col-md-3"><label class="form-label">10th Board</label>
            <select name="tenth_board" class="form-select" data-value="{{ student.tenth_board or '' }}"></select>
          </div>

          <div class="col-md-3"><label class="form-label">10th %</label>
            <input name="tenth_percent" type="number" step="0.01" class="form-control" value="{{ student.tenth_percent or '' }}">
          </div>

          <div class="col-md-3"><label class="form-label">12th Board</label>
            <select name="twelfth_board" class="form-select" data-value="{{ student.twelfth_board or '' }}"></select>
          </div>

          <div class="col-md-3"><label class="form-label">12th %</label>
            <input name="twelfth_percent" type="number" step="0.01" class="form-control" value="{{ student.twelfth_percent or '' }}">
          </div>

          <div class="col-md-6"><label class="form-label">Last Exam Passed</label>
            <input name="last_exam_passed" class="form-control" value="{{ student.last_exam_passed or '' }}">
          </div>

        </div>
      </div>

      <!-- FAMILY TAB -->
      <div class="tab-pane fade" id="family">
        <div class="row g-3">

          <div class="col-md-4"><label class="form-label">Father Name</label>
            <input name="father_name" class="form-control" value="{{ student.father_name or '' }}">
          </div>

          <div class="col-md-4"><label class="form-label">Father Occupation</label>
            <select name="father_occupation" class="form-select" data-value="{{ student.father_occupation or '' }}"></select>
          </div>

          <div class="col-md-4"><label class="form-label">Father Mobile</label>
            <input name="father_mobile" class="form-control" value="{{ student.father_mobile or '' }}">
          </div>

          <div class="col-md-4"><label class="form-label">Mother Name</label>
            <input name="mother_name" class="form-control" value="{{ student.mother_name or '' }}">
          </div>

          <div class="col-md-4"><label class="form-label">Mother Occupation</label>
            <select name="mother_occupation" class="form-select" data-value="{{ student.mother_occupation or '' }}"></select>
          </div>

          <div class="col-md-4"><label class="form-label">Mother Mobile</label>
            <input name="mother_mobile" class="form-control" value="{{ student.mother_mobile or '' }}">
          </div>

          <div class="col-md-4"><label class="form-label">Guardian Name</label>
            <input name="guardian_name" class="form-control" value="{{ student.guardian_name or '' }}">
          </div>

          <div class="col-md-4"><label class="form-label">Guardian Mobile</label>
            <input name="guardian_mobile" class="form-control" value="{{ student.guardian_mobile or '' }}">
          </div>

          <div class="col-md-4"><label class="form-label">Guardian Email</label>
            <input name="guardian_email" type="email" class="form-control" value="{{ student.guardian_email or '' }}">
          </div>

          <div class="col-md-4"><label class="form-label">Annual Income</label>
            <input name="annual_income" class="form-control" value="{{ student.annual_income or '' }}">
          </div>

        </div>
      </div>

      <!-- BANK TAB -->
      <div class="tab-pane fade" id="bank">
        <div class="row g-3">
          <div class="col-md-6"><label class="form-label">Account Holder</label>
            <input name="account_holder" class="form-control" value="{{ student.account_holder or '' }}">
          </div>

          <div class="col-md-6"><label class="form-label">Account Number</label>
            <input name="account_number" class="form-control" value="{{ student.account_number or '' }}">
          </div>

          <div class="col-md-4"><label class="form-label">IFSC</label>
            <input name="ifsc" class="form-control" value="{{ student.ifsc or '' }}">
          </div>

          <div class="col-md-8"><label class="form-label">Bank Name</label>
            <input name="bank_name" class="form-control" value="{{ student.bank_name or '' }}">
          </div>
        </div>
      </div>

      <!-- DOCUMENTS TAB -->
      <div class="tab-pane fade" id="docs">
        <div class="row g-3">
          <div class="col-md-6"><label class="form-label">Photo URL</label>
            <input name="photo_url" class="form-control" value="{{ student.photo_url or '' }}">
          </div>

          <div class="col-md-6"><label class="form-label">10th Marksheet</label>
            <input name="marksheet_url" class="form-control" value="{{ student.marksheet_url or '' }}">
          </div>

          <div class="col-md-6"><label class="form-label">Aadhaar</label>
            <input name="aadhaar_url" class="form-control" value="{{ student.aadhaar_url or '' }}">
          </div>

          <div class="col-md-6"><label class="form-label">Transfer Certificate</label>
            <input name="tc_url" class="form-control" value="{{ student.tc_url or '' }}">
          </div>

          <div class="col-md-6"><label class="form-label">Migration Certificate</label>
            <input name="migration_url" class="form-control" value="{{ student.migration_url or '' }}">
          </div>
        </div>
      </div>

    </div>

    <!-- Navigation -->
    <div class="mt-4 d-flex justify-content-between">
      <button type="button" class="btn btn-secondary" id="prevBtn">‚¨Ö Back</button>
      <button type="button" class="btn btn-primary" id="nextBtn">Next ‚û°</button>
      <button type="submit" class="btn btn-success d-none" id="saveBtn">
        {{ 'üîÑ Update Student' if mode == 'edit' else 'üíæ Save Student' }}
      </button>
    </div>

  </form>
</div>

<style>
.glassy-form {
  background: rgba(255, 255, 255, 0.65);
  backdrop-filter: blur(12px);
  border-radius: 12px;
  transition: all 0.3s ease;
}
.glassy-form:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 16px rgba(0, 245, 212, 0.25);
}
</style>

<script>
async function loadMasters() {

  const masters = {
    session: ["session"],
    course: ["course"],
    branch: ["branch"],
    department: ["department"],
    batch: ["batch"],
    religion: ["religion"],
    caste: ["caste"],
    category: ["category"],
    board: ["tenth_board", "twelfth_board"],
    occupation: ["father_occupation", "mother_occupation"]
  };

  for (const [master, fields] of Object.entries(masters)) {
    try {
      const res = await fetch(`/master/${master}/items`);
      const data = await res.json();

      fields.forEach(fieldName => {
        const selects = document.querySelectorAll(`[name='${fieldName}']`);
        selects.forEach(sel => {
          sel.innerHTML = "";
          (data.items || []).forEach(it => {
            const opt = document.createElement("option");
            opt.value = it.name;
            opt.textContent = it.name;
            sel.appendChild(opt);
          });
          const val = sel.dataset.value;
          if (val) sel.value = val;
        });
      });

    } catch (e) {
      console.warn("‚ö†Ô∏è Master load failed for", master, e);
    }
  }
}

document.addEventListener("DOMContentLoaded", () => {
  const tabs = [...document.querySelectorAll("#studentTabs .nav-link")];
  const nextBtn = document.getElementById("nextBtn");
  const prevBtn = document.getElementById("prevBtn");
  const saveBtn = document.getElementById("saveBtn");
  const form = document.getElementById("studentForm");
  let currentStep = 0;

  function showStep(i) {
    tabs.forEach((tab, idx) => {
      const pane = document.querySelector(tab.dataset.bsTarget);
      tab.classList.toggle("active", idx === i);
      pane.classList.toggle("show", idx === i);
      pane.classList.toggle("active", idx === i);
    });
    prevBtn.style.visibility = i === 0 ? "hidden" : "visible";
    nextBtn.classList.toggle("d-none", i === tabs.length - 1);
    saveBtn.classList.toggle("d-none", i !== tabs.length - 1);
  }

  nextBtn.addEventListener("click", () => {
    if (currentStep < tabs.length - 1) currentStep++;
    showStep(currentStep);
  });

  prevBtn.addEventListener("click", () => {
    if (currentStep > 0) currentStep--;
    showStep(currentStep);
  });

  form.addEventListener("submit", () => {
    saveBtn.disabled = true;
    saveBtn.innerHTML = "‚è≥ Processing...";
  });

  loadMasters();
  showStep(currentStep);
});
</script>

{% endblock %}
